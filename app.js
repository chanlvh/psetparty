// Generated by IcedCoffeeScript 1.3.3f
(function() {
  var $, app, buildingaddress, buildingdata, buildingname, classdata, classes, classlist, classlist_set, everyone, express, fs, getCalendarId, getClasses, getEvents, getEventsForUser, http, httpserver, iced, line, location_addresses, location_list, nowjs, parseEvent, rclient, redis, request, restler, subjectnum, __iced_k, __iced_k_noop, _i, _j, _len, _len1, _ref, _ref1, _ref2;

  iced = require('iced-coffee-script').iced;
  __iced_k = __iced_k_noop = function() {};

  fs = require('fs');

  request = require('request');

  $ = require('jQuery');

  restler = require('restler');

  redis = require('redis');

  rclient = redis.createClient();

  express = require('express');

  app = express();

  http = require('http');

  httpserver = http.createServer(app);

  httpserver.listen(3333);

  nowjs = require('now');

  everyone = nowjs.initialize(httpserver);

  app.configure('development', function() {
    return app.use(express.errorHandler());
  });

  app.configure(function() {
    app.set('views', __dirname + '/views');
    app.set('view engine', 'ejs');
    app.use(express.bodyParser());
    app.use(express.methodOverride());
    app.set('view options', {
      layout: false
    });
    app.locals({
      layout: false
    });
    return app.use(express["static"](__dirname + '/'));
  });

  classes = JSON.parse(fs.readFileSync('psetparty.json', 'utf-8')).cl;

  classlist = [];

  classlist_set = {};

  classdata = fs.readFileSync('classes.txt', 'utf-8');

  _ref = classdata.split('\n');
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    line = _ref[_i];
    if (line.indexOf('\t') === -1) continue;
    subjectnum = line.split('\t')[0];
    if (!(classlist_set[subjectnum] != null)) {
      classlist_set[subjectnum] = true;
      classlist.push(subjectnum);
    }
  }

  classlist.sort();

  buildingdata = fs.readFileSync('buildings.txt', 'utf-8');

  location_list = [];

  location_addresses = {};

  _ref1 = buildingdata.split('\n');
  for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
    line = _ref1[_j];
    _ref2 = line.split('\t'), buildingname = _ref2[0], buildingaddress = _ref2[1];
    location_list.push(buildingname);
    location_addresses[buildingname] = buildingaddress;
  }

  everyone.now.location_list = location_list;

  everyone.now.location_addresses = location_addresses;

  everyone.now.addClassType = function(classname) {
    if (typeof classname !== typeof '') return;
    if (!(classlist_set[classname] != null)) {
      classlist_set[classname] = true;
      classlist.push(classname);
      return classlist.sort();
    }
  };

  everyone.now.getClassesWithPrefix = function(prefix, callback) {
    var matches, x;
    matches = (function() {
      var _k, _len2, _results;
      _results = [];
      for (_k = 0, _len2 = classlist.length; _k < _len2; _k++) {
        x = classlist[_k];
        if (x.indexOf(prefix) === 0) _results.push(x);
      }
      return _results;
    })();
    return callback(matches);
  };

  everyone.now.getCalendarId = getCalendarId = function(classname, callback) {
    return restler.get('http://localhost:5000/calid?title=' + classname).on('complete', callback);
  };

  root.classids = {};

  /*
  # s: "2013-01-21T07:30:00-05:00"
  splitTimeRange = (s) ->
    [date,timerange] = s.split('T')
    [start,end] = timerange.split('-')
    startTime = new Date(date + 'T' + start)
    endTime = new Date(date + 'T' + end)
    return [startTime, endTime]
  */


  parseEvent = function(event) {
    return {
      id: event.id,
      title: event.summary,
      start: new Date(event.start.dateTime),
      end: new Date(event.end.dateTime)
    };
  };

  getEventsForUser = everyone.now.getEventsForUser = function(username, callback) {
    var classlist, event, events, events_for_class, events_per_class, i, title, ___iced_passed_deferral, __iced_deferrals, __iced_k,
      _this = this;
    __iced_k = __iced_k_noop;
    ___iced_passed_deferral = iced.findDeferral(arguments);
    (function(__iced_k) {
      __iced_deferrals = new iced.Deferrals(__iced_k, {
        parent: ___iced_passed_deferral,
        filename: "app.coffee",
        funcname: "getEventsForUser"
      });
      getClasses(username, __iced_deferrals.defer({
        assign_fn: (function() {
          return function() {
            return classlist = arguments[0];
          };
        })(),
        lineno: 95
      }));
      __iced_deferrals._fulfill();
    })(function() {
      events_per_class = [];
      (function(__iced_k) {
        var _k, _len2;
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "app.coffee",
          funcname: "getEventsForUser"
        });
        for (i = _k = 0, _len2 = classlist.length; _k < _len2; i = ++_k) {
          title = classlist[i];
          getEvents(title, __iced_deferrals.defer({
            assign_fn: (function(__slot_1, __slot_2) {
              return function() {
                return __slot_1[__slot_2] = arguments[0];
              };
            })(events_per_class, i),
            lineno: 99
          }));
        }
        __iced_deferrals._fulfill();
      })(function() {
        var _k, _l, _len2, _len3;
        events = [];
        for (_k = 0, _len2 = events_per_class.length; _k < _len2; _k++) {
          events_for_class = events_per_class[_k];
          for (_l = 0, _len3 = events_for_class.length; _l < _len3; _l++) {
            event = events_for_class[_l];
            events.push(event);
          }
        }
        return callback(events);
      });
    });
  };

  getEvents = everyone.now.getEvents = function(title, callback) {
    return restler.get('http://localhost:5000/events?title=' + title).on('complete', function(events) {
      var event, items, _ref3;
      items = (_ref3 = events.items) != null ? _ref3 : [];
      return callback((function() {
        var _k, _len2, _results;
        _results = [];
        for (_k = 0, _len2 = items.length; _k < _len2; _k++) {
          event = items[_k];
          _results.push(parseEvent(event));
        }
        return _results;
      })());
    });
  };

  app.get('/events', function(req, res) {
    var title, username;
    title = req.query.title;
    if (title != null) {
      getEvents(title, function(x) {
        return res.json(x);
      });
      return;
    }
    username = req.query.username;
    if (username != null) {
      getEventsForUser(username, function(x) {
        return res.json(x);
      });
      return;
    }
    return res.send('no title or username specified');
  });

  app.get('/classes', function(req, res) {
    var username;
    username = req.query.username;
    if (username != null) {
      return getClasses(username, function(x) {
        return res.json(x);
      });
    }
  });

  app.get('/save', function(req, res) {
    var ndata;
    ndata = JSON.stringify({
      cl: classes
    });
    fs.writeFileSync('psetparty.json', ndata, 'utf-8');
    return res.send(ndata);
  });

  everyone.now.getCalendarIds = function(classnames, callback) {
    var i, title, ___iced_passed_deferral, __iced_deferrals, __iced_k,
      _this = this;
    __iced_k = __iced_k_noop;
    ___iced_passed_deferral = iced.findDeferral(arguments);
    (function(__iced_k) {
      var _k, _len2;
      __iced_deferrals = new iced.Deferrals(__iced_k, {
        parent: ___iced_passed_deferral,
        filename: "app.coffee",
        funcname: "getCalendarIds"
      });
      for (i = _k = 0, _len2 = classnames.length; _k < _len2; i = ++_k) {
        title = classnames[i];
        if (!(root.classids[title] != null)) {
          getCalendarId(title, __iced_deferrals.defer({
            assign_fn: (function(__slot_1, __slot_2) {
              return function() {
                return __slot_1[__slot_2] = arguments[0];
              };
            })(classids, title),
            lineno: 137
          }));
        }
      }
      __iced_deferrals._fulfill();
    })(function() {
      return callback(root.classids);
    });
  };

  everyone.now.getClasses = getClasses = function(username, callback) {
    if (!(classes[username] != null)) classes[username] = [];
    if (callback != null) return callback(classes[username]);
  };

  everyone.now.addClass = function(username, classname, callback) {
    if (!(classes[username] != null)) classes[username] = [];
    if (classes[username].indexOf(classname) === -1) {
      classes[username].push(classname);
    }
    if (callback != null) return callback(classes[username]);
  };

  everyone.now.removeClass = function(username, classname, callback) {
    var x;
    if (!(classes[username] != null)) classes[username] = [];
    classes[username] = (function() {
      var _k, _len2, _ref3, _results;
      _ref3 = classes[username];
      _results = [];
      for (_k = 0, _len2 = _ref3.length; _k < _len2; _k++) {
        x = _ref3[_k];
        if (x !== classname) _results.push(x);
      }
      return _results;
    })();
    if (callback != null) return callback(classes[username]);
  };

}).call(this);
